// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String      @id @default(uuid())
  name         String
  email        String      @unique
  passwordHash String
  role         UserRole
  storeId      String
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  store       Store        @relation(fields: [storeId], references: [id], onDelete: Cascade)
  auditLogs   AuditLog[]
  invoices    Invoice[]

  @@index([storeId])
  @@index([email])
}

model Store {
  id           String   @id @default(uuid())
  name         String
  address      String
  phone        String? 
  email        String? 
  logo         String?
  taxSettings  Json     @default("{\"taxRate\": 0}")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  users        User[]
  products     Product[]
  invoices     Invoice[]
  expenses     Expense[]
  customers    Customer[]

  @@index([name])
}

model Product {
  id            String   @id @default(uuid())
  sku           String   @unique
  name          String
  barcode       String   @unique
  description   String? 
  costPrice     Decimal  @db. Decimal(10, 2)
  sellPrice     Decimal  @db. Decimal(10, 2)
  taxRate       Decimal  @db. Decimal(5, 2) @default(0)
  stockQty      Int      @default(0)
  reorderLevel  Int      @default(10)
  categoryId    String
  storeId       String
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  category      Category          @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  store         Store             @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invoiceItems  InvoiceItem[]
  stockMovements StockMovement[]

  @@index([storeId])
  @@index([categoryId])
  @@index([barcode])
  @@index([sku])
}

model Category {
  id        String   @id @default(uuid())
  name      String
  createdAt DateTime @default(now())

  products  Product[]
  expenses  Expense[]

  @@unique([name])
}

model Customer {
  id            String   @id @default(uuid())
  storeId       String
  name          String
  phone         String?
  email         String?
  loyaltyPoints Int      @default(0)
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  store         Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  invoices      Invoice[]

  @@index([storeId])
  @@index([phone])
  @@index([email])
}

model Invoice {
  id            String   @id @default(uuid())
  invoiceNo     String   @unique
  storeId       String
  customerId    String? 
  createdById   String
  subtotal      Decimal  @db. Decimal(12, 2)
  taxTotal      Decimal  @db. Decimal(12, 2)
  discountTotal Decimal  @db. Decimal(12, 2) @default(0)
  roundOff      Decimal  @db. Decimal(5, 2) @default(0)
  total         Decimal  @db.Decimal(12, 2)
  paymentMethod String   @default("CASH") // CASH, CARD, UPI, CHEQUE
  notes         String?
  status        InvoiceStatus @default(COMPLETED)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  store         Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer      Customer?      @relation(fields: [customerId], references: [id], onDelete: SetNull)
  createdBy     User          @relation(fields: [createdById], references: [id])
  items         InvoiceItem[]

  @@index([storeId])
  @@index([customerId])
  @@index([createdAt])
  @@index([invoiceNo])
}

model InvoiceItem {
  id         String  @id @default(uuid())
  invoiceId  String
  productId  String
  qty        Int
  unitPrice  Decimal @db.Decimal(10, 2)
  discount   Decimal @db.Decimal(10, 2) @default(0)
  taxAmount  Decimal @db.Decimal(10, 2)
  lineTotal  Decimal @db. Decimal(12, 2)

  invoice    Invoice @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  product    Product @relation(fields: [productId], references: [id])

  @@index([invoiceId])
  @@index([productId])
}

model Expense {
  id          String   @id @default(uuid())
  storeId     String
  categoryId  String
  amount      Decimal  @db. Decimal(12, 2)
  date        DateTime
  notes       String?
  receiptUrl  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store       Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category    Category @relation(fields: [categoryId], references: [id])

  @@index([storeId])
  @@index([categoryId])
  @@index([date])
}

model StockMovement {
  id          String   @id @default(uuid())
  productId   String
  storeId     String
  qty         Int
  type        StockMovementType
  referenceId String? 
  notes       String?
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([storeId])
  @@index([createdAt])
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String
  action    String
  entity    String
  entityId  String
  changes   Json? 
  ipAddress String? 
  userAgent String?
  timestamp DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([timestamp])
}

enum UserRole {
  ADMIN
  MANAGER
  CASHIER
  ACCOUNTANT
}

enum StockMovementType {
  IN
  OUT
  ADJUSTMENT
}

enum InvoiceStatus {
  DRAFT
  COMPLETED
  RETURNED
  CANCELLED
}